pr:
  branches:
    include:
      - main

trigger: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: news-app-stg
  - group: netlify-auth
  - name: NODE_VERSION
    value: '20'

stages:
  - stage: Test
    jobs:
      - job: UnitTests
        displayName: 'Run Unit & Functional Tests'
        steps:
          - checkout: self
          - task: NodeTool@0
            inputs:
              versionSpec: '$(NODE_VERSION)'
          - script: |
              set -eo pipefail
              npm ci
              npm test
            displayName: 'Run tests'

  - stage: BuildDeploy
    dependsOn: Test
    condition: succeeded()
    jobs:
      - job: BuildAndDeploy
        displayName: 'Build & Deploy to Netlify (Staging)'
        env:
          VITE_API_URL: $(VITE_API_URL_STAGING)
        steps:
          - checkout: self
          - task: NodeTool@0
            inputs:
              versionSpec: '$(NODE_VERSION)'
          - script: |
              set -eo pipefail
              npm ci
              npm run build
              npm install -g netlify-cli
              netlify deploy \
                --auth $(NETLIFY_AUTH_TOKEN) \
                --site $(NETLIFY_SITE_ID) \
                --dir=dist \
                --prod \
                --json
            displayName: 'Build & Deploy'

  - stage: E2E
    displayName: 'Run Playwright E2E Tests'
    dependsOn: BuildDeploy
    condition: succeeded()
    jobs:
      - job: RunE2ETests
        displayName: 'E2E Tests on Staging'
        timeoutInMinutes: 60
        env:
          ENV: staging
          BASE_URL: $(BASE_URL_STAGING)
          VITE_API_URL: $(VITE_API_URL_STAGING)
        steps:
          - checkout: self

          - task: NodeTool@0
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - script: |
              set -eo pipefail
              npm ci --force
            displayName: 'Install Dependencies'
          - script: |
              set -eo pipefail
              npx playwright install --with-deps --force
            displayName: 'Install Playwright Browsers'

          - script: |
              npx playwright --version
            displayName: 'Playwright Version'

          - script: |
              set -eo pipefail
              echo "Running Playwright E2E tests against $BASE_URL"
              npx playwright test \
                --project=local-chrome \
                --project=local-firefox \
                --project=local-safari \
                --reporter=junit,line \
            displayName: 'Run Playwright Tests'
            timeoutInMinutes: 15

          - task: PublishTestResults@2
            displayName: 'Publish E2E Test Results'
            condition: always()
            inputs:
              testResultsFiles: '**/test-results/junitReport.xml'
              testRunTitle: 'Playwright E2E Tests (Staging)'

          - task: PublishPipelineArtifact@1
            displayName: 'Upload Playwright HTML Report'
            condition: always()
            inputs:
              targetPath: 'playwright-report'
              artifact: 'Playwright HTML Report'
